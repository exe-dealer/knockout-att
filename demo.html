<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>knockout-flatBindingProvider</title>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-debug.js"></script>
  <script src="knockout-flatBindingProvider.js"></script>

  <script> // test
    (function () {
      var node = { nodeType: 1, attributes: [
        { name: "data-bind-a.a.a", value: "0" },
        { name: "data-bind-a.a.b", value: "0" },
        { name: "data-bind-a.b.a", value: "0" },
        { name: "data-bind-b", value: "0" },
        { name: "data-bind-under_score", value: "0" }
      ]};

      var actual = ko.flatBindingProvider.prototype._getNodeBindingsString(node),
        expected = '"a":{"a":{"a":0,"b":0},"b":{"a":0}},"b":0,"underScore":0';

      console.assert(actual === expected, actual + '\n' + expected);
    })();
  </script>

  <style>


    body {
      font-family: 'DejaVu Sans', 'Verdana', sans;
    }

    ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }

    li > header > a {
      display: block;
      color: inherit;
      text-decoration: none;
      cursor: pointer;
      font-family: inherit;
    }

    li > header {
      padding-left: .2em;
    }

    li > header:hover {
      background-color: rgba(0,0,0,.1);
    }

    .treenode {
      position: relative;
      padding-left: 1em;
      line-height: 1.5em;
    }

    .treenode-toggler {
      outline: none;
      margin: 0;
      padding: 0;
      border: none;
      color: inherit;
      background: none;
      font-family: inherit;
      line-height: 1em;
      cursor: pointer;
      opacity: 0.5;

      position: absolute;
      top: .4em;
      left: 0;
      font-size: .8em;
      width: 1em;
      height: 1em;
      opacity: 0.5;
      border-style: solid;
      border-width: .5em 0 .5em .7em;
      border-color: transparent transparent transparent black;
      user-select: none;
      -moz-box-sizing: border-box;
           box-sizing: border-box;
    }

    .treenode-toggler:hover {
      opacity: 1;
    }

    /*.treenode-toggler::-webkit-focus-inner,*/
    .treenode-toggler::-moz-focus-inner {
      border: none;
    }

    .treenode-toggler.expanded {
      -webkit-transform-origin: .35em .5em;
         -moz-transform-origin: .35em .5em;
          -ms-transform-origin: .35em .5em;
              transform-origin: .35em .5em;
      -webkit-transform: rotate(90deg);
         -moz-transform: rotate(90deg);
          -ms-transform: rotate(90deg);
              transform: rotate(90deg);
    }

    .treenode-toggler.loading {
      border: .2em solid;
      border-top-color: transparent;
      border-left-color: transparent;
      border-radius: 50%;
      -webkit-transform-origin: center center;
         -moz-transform-origin: center center;
          -ms-transform-origin: center center;
      -webkit-animation: spin .5s infinite linear;
         -moz-animation: spin .5s infinite linear;
          -ms-animation: spin .5s infinite linear;
    }

    @-webkit-keyframes spin {
      from { -webkit-transform: rotate(0deg); }
      to   { -webkit-transform: rotate(360deg); }
    }

    @-moz-keyframes spin {
      from { -moz-transform: rotate(0deg); }
      to   { -moz-transform: rotate(360deg); }
    }

    @-ms-keyframes spin {
      from { -ms-transform: rotate(0deg); }
      to   { -ms-transform: rotate(360deg); }
    }

    @-keyframes spin {
      from { -ms-transform: rotate(0deg); }
      to   { -ms-transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <main data-bind-template.name="'tree-tmpl'"></main>

  <script id="tree-tmpl" type="text/html">
    <ul data-bind-foreach="children">
      <li class="treenode">

        <button class="treenode-toggler"
                data-bind-click="toggle"
                data-bind-visible="hasChildren"
                data-bind-css.collapsed="!isExpanded()"
                data-bind-css.expanded="isExpanded"
                data-bind-css.loading="isLoading"></button>

        <header>
          <a data-bind-attr.href="'#' + name"
             data-bind-click="open"
             data-bind-text="name"></a>
        </header>

        <!-- ko template: {
          name : 'tree-tmpl',
          if   : isExpanded
        } --><!-- /ko -->

      </li>
    </ul>
  </script>

  <script>

    function TreeNode(name, level) {
      this.name = name;
      this.isExpanded = ko.observable(false);
      this.isLoading = ko.observable(false);
      this.children = ko.observable();
      this._level = level || 0;
      this.hasChildren = ko.observable(this._level < 3);
    }

    TreeNode.prototype.toggle = function () {
      if (this.isExpanded()) {
        this.isExpanded(false);
        this.isLoading(false);
      } else {
        this.isExpanded(true);
        this.isLoading(true);
        this.children(null);
        setTimeout(this._onChildrenReady.bind(this), 1000);
      }
    };

    TreeNode.prototype._onChildrenReady = function () {
      this.isLoading(false);
      this.children(['one', 'two', 'three', 'four', 'five'].map(function (name) {
        return new TreeNode(name, this._level + 1);
      }, this));
    };

    TreeNode.prototype.open = function () {
      alert(this.name + ' opened');
    };

    ko.bindingProvider.instance = new ko.flatBindingProvider();

    var model = new TreeNode('root');
    model.isExpanded(true);
    model._onChildrenReady();

    ko.applyBindings(model);
  </script>



</body>
</html>
